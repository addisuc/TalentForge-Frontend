import{g as c}from"./chunk-UY2YNJ4I.js";import{b as l}from"./chunk-5W2ODH74.js";import{H as s,ca as i,ga as h,k as a,la as u,r as o,v as n}from"./chunk-4D7AL5UB.js";var d=(()=>{class r{constructor(t,e){this.http=t,this.router=e,this.API_URL="/api/auth",this.currentUserSubject=new a(null),this.tokenSubject=new a(null),this.currentUser$=this.currentUserSubject.asObservable(),this.token$=this.tokenSubject.asObservable(),this.loadStoredAuth()}login(t){return this.http.post(`${this.API_URL}/login`,t).pipe(n(e=>this.mapLoginResponse(e)),i(e=>this.setAuthData(e)),s(e=>this.handleAuthError(e)))}register(t){return this.http.post(`${this.API_URL}/register`,t).pipe(n(e=>this.mapLoginResponse(e)),i(e=>this.setAuthData(e)),s(e=>this.handleAuthError(e)))}logout(){let t=this.getToken();t&&this.http.post(`${this.API_URL}/logout`,{},{headers:{Authorization:`Bearer ${t}`}}).subscribe(),this.clearAuthData(),this.router.navigate(["/auth/login"])}refreshToken(){return this.http.post(`${this.API_URL}/refresh`,{}).pipe(i(t=>this.setAuthData(t)),s(t=>(this.logout(),o(t))))}getCurrentUser(){return this.http.get(`${this.API_URL}/me`)}hasRole(t){return this.currentUserSubject.value?.role===t||!1}isAuthenticated(){return!!this.tokenSubject.value&&!!this.currentUserSubject.value}getToken(){return this.tokenSubject.value}getCurrentUserValue(){return this.currentUserSubject.value}setAuthData(t){localStorage.setItem("token",t.token),localStorage.setItem("user",JSON.stringify(t.user)),this.tokenSubject.next(t.token),this.currentUserSubject.next(t.user)}clearAuthData(){localStorage.removeItem("token"),localStorage.removeItem("user"),this.tokenSubject.next(null),this.currentUserSubject.next(null)}loadStoredAuth(){let t=localStorage.getItem("token"),e=localStorage.getItem("user");if(t&&e)try{let m=JSON.parse(e);this.tokenSubject.next(t),this.currentUserSubject.next(m)}catch{this.clearAuthData()}}mapLoginResponse(t){return{user:{id:t.userId,email:t.email,firstName:t.firstName,lastName:t.lastName,role:t.role,isEmailVerified:!0,createdAt:new Date,updatedAt:new Date},token:t.accessToken,refreshToken:t.refreshToken,expiresIn:t.expiresIn}}handleAuthError(t){let e="An error occurred";return t.status===401?e="Invalid email or password":t.status===403?e="Please verify your email before logging in":t.status===422?e="Password has expired. Please reset your password":t.status===423?e="Account temporarily locked. Try again later":t.status===500?e="Service temporarily unavailable. Please try again":navigator.onLine||(e="Connection lost. Check your internet connection"),o({message:e,originalError:t})}static{this.\u0275fac=function(e){return new(e||r)(u(l),u(c))}}static{this.\u0275prov=h({token:r,factory:r.\u0275fac,providedIn:"root"})}}return r})();export{d as a};
