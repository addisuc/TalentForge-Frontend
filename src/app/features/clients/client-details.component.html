<div class="client-details-page">
  <div class="breadcrumb">
    <a routerLink="/clients">‚Üê Back to Clients</a>
  </div>

  <div class="error" *ngIf="!loading && !client">
    <p>Failed to load client details. Please try again.</p>
  </div>

  <div class="header" *ngIf="client">
    <div class="client-info">
      <div class="logo">{{ getInitials(client.name) }}</div>
      <div>
        <h1>{{ client.name }}</h1>
        <p class="industry">{{ client.industry || 'Industry' }}</p>
      </div>
    </div>
    <div class="actions">
      <button class="btn-secondary" (click)="editClient()">‚úèÔ∏è Edit</button>
      <button class="btn-secondary" (click)="contactClient()">‚úâÔ∏è Contact</button>
      <button class="btn-secondary" (click)="addNote()">üìù Add Note</button>
      <button class="btn-primary" (click)="createJob()">‚ûï New Job</button>
    </div>
  </div>

  <div class="stats-grid">
    <div class="stat-card" *ngFor="let stat of stats">
      <span class="icon">{{ stat.icon }}</span>
      <div>
        <div class="value">{{ stat.value }}</div>
        <div class="label">{{ stat.label }}</div>
      </div>
    </div>
  </div>

  <div class="tabs">
    <button class="tab" [class.active]="activeTab === 'overview'" (click)="activeTab = 'overview'">Overview</button>
    <button class="tab" [class.active]="activeTab === 'job-requests'" (click)="activeTab = 'job-requests'">
      Job Requests
      <span class="tab-badge" *ngIf="pendingJobRequests > 0">{{ pendingJobRequests }}</span>
    </button>
    <button class="tab" [class.active]="activeTab === 'submissions'" (click)="activeTab = 'submissions'">
      Candidate Submissions
      <span class="tab-badge" *ngIf="pendingApprovals > 0">{{ pendingApprovals }}</span>
    </button>
    <button class="tab" [class.active]="activeTab === 'feedback'" (click)="activeTab = 'feedback'">
      Client Feedback
      <span class="tab-badge" *ngIf="unreadFeedback > 0">{{ unreadFeedback }}</span>
    </button>
    <button class="tab" [class.active]="activeTab === 'interviews'" (click)="activeTab = 'interviews'">Interviews</button>
  </div>

  <div class="content-grid">
    <div class="main-content">
      <!-- Overview Tab -->
      <div *ngIf="activeTab === 'overview'">
        <div class="section">
          <h2>About</h2>
          <p>{{ client.description }}</p>
        </div>

        <div class="section">
        <div class="section-header">
          <h2>Job Orders ({{ jobs.length }})</h2>
        </div>
        <div class="jobs-list" *ngIf="jobs.length > 0">
          <div class="job-item" *ngFor="let job of jobs" (click)="viewJob(job.id)" style="cursor: pointer;">
            <div class="job-info">
              <h3>{{ job.title }}</h3>
              <span class="meta">{{ getApplicationCount(job.id) }} applications ‚Ä¢ Posted {{ job.createdAt | date:'MMM d, yyyy' }}</span>
            </div>
            <span class="status" [class.active]="job.status === 'OPEN' || job.status === 'ACTIVE'">{{ job.status }}</span>
          </div>
        </div>
        <p *ngIf="jobs.length === 0" class="empty-state">No jobs posted for this client yet.</p>
      </div>
      
      <div class="section">
        <div class="section-header">
          <h2>Notes ({{ notes.length }})</h2>
        </div>
        <div class="notes-list" *ngIf="notes.length > 0">
          <div class="note-item" *ngFor="let note of notes">
            <p class="note-text">{{ note.note }}</p>
            <span class="note-date">{{ note.createdAt | date:'MMM d, yyyy h:mm a' }}</span>
          </div>
        </div>
        <p *ngIf="notes.length === 0" class="empty-state">No notes yet. Click "Add Note" to add one.</p>
      </div>

      <div class="section">
        <h2>Recent Hires ({{ recentHires.length }})</h2>
        <div class="hires-list" *ngIf="recentHires.length > 0">
          <div class="hire-item" *ngFor="let hire of recentHires">
            <span class="avatar">{{ hire.avatar }}</span>
            <div class="hire-info">
              <div class="name">{{ hire.name }}</div>
              <div class="position">{{ hire.position }}</div>
            </div>
            <span class="date">{{ hire.date | date:'MMM d, yyyy' }}</span>
          </div>
        </div>
        <p *ngIf="recentHires.length === 0" class="empty-state">No hires yet.</p>
      </div>

        <div class="section">
          <h2>Activity Timeline</h2>
          <div class="timeline" *ngIf="activities.length > 0">
          <div class="timeline-item" *ngFor="let activity of activities">
            <span class="timeline-icon">{{ activity.icon }}</span>
            <div class="timeline-content">
              <div class="timeline-header">
                <strong>{{ activity.title }}</strong>
                <span class="timeline-date">{{ activity.date | date:'MMM d, yyyy h:mm a' }}</span>
              </div>
              <p class="timeline-description">{{ activity.description }}</p>
            </div>
          </div>
        </div>
          <p *ngIf="activities.length === 0" class="empty-state">No activity yet.</p>
        </div>
      </div>

      <!-- Job Requests Tab -->
      <div *ngIf="activeTab === 'job-requests'">
        <div class="section">
          <div class="section-header">
            <h2>Job Requests from Client</h2>
            <div class="filter-tabs">
              <button [class.active]="jobRequestFilter === 'pending'" (click)="jobRequestFilter = 'pending'">Pending ({{ getPendingJobRequests().length }})</button>
              <button [class.active]="jobRequestFilter === 'approved'" (click)="jobRequestFilter = 'approved'">Approved ({{ approvedJobRequests }})</button>
              <button [class.active]="jobRequestFilter === 'all'" (click)="jobRequestFilter = 'all'">All</button>
            </div>
          </div>
          
          <div class="job-requests-list">
            <div class="job-request-card" *ngFor="let request of getFilteredJobRequests()">
              <div class="request-header">
                <div>
                  <h3>{{ request.title }}</h3>
                  <p class="request-meta">{{ request.department }} ‚Ä¢ {{ request.location }} ‚Ä¢ {{ request.employmentType }}</p>
                  <p class="request-id" *ngIf="request.requestId" style="margin-top: 4px;"><small>Request ID: <code>{{ request.requestId }}</code></small></p>
                </div>
                <span class="status-badge" [class]="request.status.toLowerCase()">{{ request.status }}</span>
              </div>
              
              <div class="request-details">
                <div class="detail-row">
                  <span class="label">Priority:</span>
                  <span class="value priority" [class]="request.priority.toLowerCase()">{{ request.priority }}</span>
                </div>
                <div class="detail-row">
                  <span class="label">Openings:</span>
                  <span class="value">{{ request.openings }}</span>
                </div>
                <div class="detail-row">
                  <span class="label">Salary Range:</span>
                  <span class="value">{{ request.salaryRange }}</span>
                </div>
                <div class="detail-row">
                  <span class="label">Requested:</span>
                  <span class="value">{{ request.requestedDate }}</span>
                </div>
              </div>
              
              <div class="request-description">
                <strong>Description:</strong>
                <p>{{ request.description }}</p>
              </div>
              
              <div class="request-requirements">
                <strong>Requirements:</strong>
                <p>{{ request.requirements }}</p>
              </div>
              
              <div class="request-actions" *ngIf="request.status === 'PENDING'">
                <button class="btn-primary" (click)="approveJobRequest(request)">‚úì Approve & Create Job</button>
                <button class="btn-secondary" (click)="viewJobRequestDetails(request)">View Full Details</button>
                <button class="btn-secondary danger" (click)="rejectJobRequest(request)">‚úó Decline</button>
              </div>
              
              <div class="request-actions" *ngIf="request.status === 'Approved'">
                <button class="btn-secondary" (click)="viewCreatedJob(request)">View Created Job</button>
              </div>
            </div>
            
            <div class="empty-state" *ngIf="getFilteredJobRequests().length === 0">
              <span class="empty-icon">üíº</span>
              <h3>No Job Requests</h3>
              <p>No {{ jobRequestFilter === 'all' ? '' : jobRequestFilter }} job requests from this client</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Candidate Submissions Tab -->
      <div *ngIf="activeTab === 'submissions'">
        <div class="section">
          <div class="section-header">
            <h2>Candidate Submissions</h2>
            <button class="btn-primary" (click)="openSubmitCandidateModal()">‚ûï Submit New Candidate</button>
          </div>
          
          <div class="submissions-list">
            <div class="submission-card" *ngFor="let submission of candidateSubmissions">
              <div class="submission-header">
                <div class="candidate-info">
                  <div class="avatar">{{ getInitials(submission.candidateName) }}</div>
                  <div>
                    <h3>{{ submission.candidateName }}</h3>
                    <p>{{ submission.position }}</p>
                  </div>
                </div>
                <span class="status-badge" [class]="submission.status.toLowerCase()">{{ submission.status }}</span>
              </div>
              
              <div class="submission-details">
                <div class="detail-item">
                  <span class="label">Submitted:</span>
                  <span class="value">{{ submission.submittedDate }}</span>
                </div>
                <div class="detail-item">
                  <span class="label">Your Rating:</span>
                  <span class="value">{{ submission.recruiterRating }}</span>
                </div>
              </div>
              
              <div class="recruiter-notes" *ngIf="submission.recruiterNotes">
                <strong>Your Notes:</strong>
                <p>{{ submission.recruiterNotes }}</p>
              </div>
              
              <div class="client-response" *ngIf="submission.clientFeedback">
                <div class="response-header">
                  <strong>Client Response:</strong>
                  <span class="response-date">{{ submission.responseDate }}</span>
                </div>
                <p>{{ submission.clientFeedback }}</p>
              </div>
              
              <div class="submission-actions">
                <button class="btn-secondary" (click)="viewCandidateProfile(submission)">View Profile</button>
                <button class="btn-secondary" *ngIf="submission.status === 'Pending Review'">Send Reminder</button>
              </div>
            </div>
            
            <div class="empty-state" *ngIf="candidateSubmissions.length === 0">
              <span class="empty-icon">üë§</span>
              <h3>No Submissions Yet</h3>
              <p>Submit candidates to this client for review</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Client Feedback Tab -->
      <div *ngIf="activeTab === 'feedback'">
        <div class="section">
          <div class="section-header">
            <h2>Feedback from Client</h2>
          </div>
          
          <div class="feedback-list">
            <div class="feedback-card" *ngFor="let feedback of clientFeedback">
              <div class="feedback-header">
                <div>
                  <span class="feedback-type" [class]="feedback.type.toLowerCase()">{{ feedback.type }}</span>
                  <h3>{{ feedback.subject }}</h3>
                </div>
                <span class="feedback-date">{{ feedback.date }}</span>
              </div>
              
              <div class="feedback-context" *ngIf="feedback.candidateName || feedback.positionTitle">
                <span *ngIf="feedback.candidateName">üë§ {{ feedback.candidateName }}</span>
                <span *ngIf="feedback.positionTitle">üíº {{ feedback.positionTitle }}</span>
              </div>
              
              <div class="feedback-message">
                <p>{{ feedback.message }}</p>
              </div>
              
              <div class="feedback-actions">
                <button class="btn-secondary" (click)="respondToFeedback(feedback)">üí¨ Respond</button>
                <button class="btn-secondary" *ngIf="!feedback.read" (click)="markAsRead(feedback)">‚úì Mark as Read</button>
              </div>
            </div>
            
            <div class="empty-state" *ngIf="clientFeedback.length === 0">
              <span class="empty-icon">üí¨</span>
              <h3>No Feedback Yet</h3>
              <p>Client feedback will appear here</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Interviews Tab -->
      <div *ngIf="activeTab === 'interviews'">
        <div class="section">
          <div class="section-header">
            <h2>Shared Interviews</h2>
            <button class="btn-primary" (click)="scheduleInterview()">üìÖ Schedule Interview</button>
          </div>
          
          <div class="interviews-list">
            <div class="interview-card" *ngFor="let interview of sharedInterviews">
              <div class="interview-header">
                <div class="interview-datetime">
                  <div class="date">{{ interview.date }}</div>
                  <div class="time">{{ interview.time }}</div>
                </div>
                <div class="interview-info">
                  <h3>{{ interview.candidateName }}</h3>
                  <p>{{ interview.position }} ‚Ä¢ {{ interview.round }}</p>
                </div>
                <span class="status-badge" [class]="interview.status.toLowerCase()">{{ interview.status }}</span>
              </div>
              
              <div class="interview-details">
                <div class="detail-item">
                  <span class="label">Interviewer:</span>
                  <span class="value">{{ interview.interviewer }}</span>
                </div>
                <div class="detail-item">
                  <span class="label">Duration:</span>
                  <span class="value">{{ interview.duration }}</span>
                </div>
                <div class="detail-item" *ngIf="interview.meetingLink">
                  <span class="label">Meeting:</span>
                  <a [href]="interview.meetingLink" target="_blank" class="meeting-link">{{ interview.platform }}</a>
                </div>
              </div>
              
              <div class="interview-actions">
                <button class="btn-secondary" (click)="editInterview(interview)">‚úèÔ∏è Edit</button>
                <button class="btn-secondary" (click)="notifyClient(interview)">üîî Notify Client</button>
                <button class="btn-secondary danger" (click)="cancelInterview(interview)">‚úó Cancel</button>
              </div>
            </div>
            
            <div class="empty-state" *ngIf="sharedInterviews.length === 0">
              <span class="empty-icon">üìÖ</span>
              <h3>No Interviews Scheduled</h3>
              <p>Schedule interviews to share with client</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="sidebar">
      <div class="info-card">
        <h3>Contact Information</h3>
        <div class="info-item">
          <span class="icon">üë§</span>
          <div>
            <div class="label">Primary Contact</div>
            <div class="value">{{ client.contactPerson || client.contact }}</div>
          </div>
        </div>
        <div class="info-item">
          <span class="icon">‚úâÔ∏è</span>
          <div>
            <div class="label">Email</div>
            <div class="value">{{ client.email }}</div>
          </div>
        </div>
        <div class="info-item">
          <span class="icon">üìû</span>
          <div>
            <div class="label">Phone</div>
            <div class="value">{{ client.phone }}</div>
          </div>
        </div>
        <div class="info-item">
          <span class="icon">üåê</span>
          <div>
            <div class="label">Website</div>
            <div class="value">{{ client.website }}</div>
          </div>
        </div>
        <div class="info-item">
          <span class="icon">üìç</span>
          <div>
            <div class="label">Address</div>
            <div class="value">{{ client.address }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Email Modal -->
  <div class="modal-overlay" *ngIf="showEmailModal" (click)="closeEmailModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Send Email to {{ client?.name }}</h2>
        <button class="close-btn" (click)="closeEmailModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>To</label>
          <input type="email" [value]="client?.email" class="form-control" readonly>
        </div>
        <div class="form-group">
          <label>Subject *</label>
          <input type="text" [(ngModel)]="emailSubject" class="form-control" placeholder="Email subject">
        </div>
        <div class="form-group">
          <label>Message *</label>
          <textarea [(ngModel)]="emailBody" class="form-control" rows="8" placeholder="Enter your message..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeEmailModal()">Cancel</button>
        <button class="btn-primary" (click)="sendEmail()" [disabled]="sending">{{ sending ? 'Sending...' : 'Send Email' }}</button>
      </div>
    </div>
  </div>

  <!-- Add Note Modal -->
  <div class="modal-overlay" *ngIf="showNoteModal" (click)="closeNoteModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Add Note</h2>
        <button class="close-btn" (click)="closeNoteModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Note *</label>
          <textarea [(ngModel)]="noteText" class="form-control" rows="6" placeholder="Enter your note about this client..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeNoteModal()">Cancel</button>
        <button class="btn-primary" (click)="saveNote()">Save Note</button>
      </div>
    </div>
  </div>

  <!-- Job Request Details Modal -->
  <div class="modal-overlay" *ngIf="showJobRequestModal" (click)="closeJobRequestModal()">
    <div class="modal large" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Job Request Details</h2>
        <button class="close-btn" (click)="closeJobRequestModal()">‚úï</button>
      </div>
      <div class="modal-body" *ngIf="selectedJobRequest">
        <div class="job-request-details">
          <div class="detail-section">
            <div class="section-header">
              <span class="section-icon">üíº</span>
              <h3>Basic Information</h3>
            </div>
            <div class="detail-grid">
              <div class="detail-item">
                <label>Job Title:</label>
                <span class="value-highlight">{{ selectedJobRequest.title }}</span>
              </div>
              <div class="detail-item">
                <label>Department:</label>
                <span>{{ selectedJobRequest.department }}</span>
              </div>
              <div class="detail-item">
                <label>Location:</label>
                <span>{{ selectedJobRequest.location }}</span>
              </div>
              <div class="detail-item">
                <label>Employment Type:</label>
                <span>{{ selectedJobRequest.employmentType }}</span>
              </div>
              <div class="detail-item">
                <label>Priority:</label>
                <span class="priority" [class]="selectedJobRequest.priority?.toLowerCase()">{{ selectedJobRequest.priority }}</span>
              </div>
              <div class="detail-item">
                <label>Number of Openings:</label>
                <span>{{ selectedJobRequest.numberOfOpenings || selectedJobRequest.openings }}</span>
              </div>
              <div class="detail-item">
                <label>Salary Range:</label>
                <span>{{ selectedJobRequest.salaryRange }}</span>
              </div>
              <div class="detail-item">
                <label>Request ID:</label>
                <span><code>{{ selectedJobRequest.requestId }}</code></span>
              </div>
            </div>
          </div>
          
          <div class="detail-section">
            <div class="section-header">
              <span class="section-icon">üìã</span>
              <h3>Job Description</h3>
            </div>
            <div class="description-content">
              {{ selectedJobRequest.description }}
            </div>
          </div>
          
          <div class="detail-section">
            <div class="section-header">
              <span class="section-icon">‚úÖ</span>
              <h3>Requirements</h3>
            </div>
            <div class="requirements-content">
              {{ selectedJobRequest.requirements }}
            </div>
          </div>
          
          <div class="detail-section">
            <div class="section-header">
              <span class="section-icon">üìÑ</span>
              <h3>Request Information</h3>
            </div>
            <div class="detail-grid">
              <div class="detail-item">
                <label>Status:</label>
                <span class="status-badge" [class]="selectedJobRequest.status?.toLowerCase()">{{ selectedJobRequest.status }}</span>
              </div>
              <div class="detail-item">
                <label>Requested Date:</label>
                <span>{{ selectedJobRequest.createdAt | date:'MMM d, yyyy h:mm a' }}</span>
              </div>
              <div class="detail-item">
                <label>Client:</label>
                <span>{{ selectedJobRequest.clientName }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeJobRequestModal()">Close</button>
        <div class="action-buttons" *ngIf="selectedJobRequest?.status === 'PENDING'">
          <button class="btn-primary" (click)="approveJobRequest(selectedJobRequest); closeJobRequestModal()">‚úì Approve & Create Job</button>
          <button class="btn-secondary danger" (click)="rejectJobRequest(selectedJobRequest); closeJobRequestModal()">‚úó Decline</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Feedback Response Modal -->
  <app-feedback-response-modal
    *ngIf="showFeedbackResponseModal && selectedFeedback"
    [applicationId]="selectedFeedback.applicationId || ''"
    [clientFeedback]="selectedFeedback.message"
    [clientId]="client.id"
    (closed)="closeFeedbackResponseModal()"
    (submitted)="onFeedbackResponseSubmitted()">
  </app-feedback-response-modal>

  <!-- Toast Notification -->
  <div class="toast" [class.show]="showToast" [class.success]="toastType === 'success'" [class.error]="toastType === 'error'">
    {{ toastMessage }}
  </div>
</div>
