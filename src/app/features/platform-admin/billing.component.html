<div class="billing-page">
  <div class="page-header">
    <div>
      <h1>Billing & Revenue</h1>
      <p>Manage subscriptions, invoices, and payments</p>
    </div>
    <div class="header-actions">
      <button class="btn-secondary" (click)="createManualInvoice()">+ Manual Invoice</button>
      <button class="btn-secondary" (click)="viewPendingRefunds()">
        ‚ö†Ô∏è Pending Refunds
        <span class="badge-count" *ngIf="pendingRefundsCount > 0">{{ pendingRefundsCount }}</span>
        <span *ngIf="pendingRefundsCount === 0" style="opacity: 0.5;">(0)</span>
      </button>
      <button class="btn-primary" (click)="exportReport()">üìä Export Report</button>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-grid">
    <div class="stat-card" *ngFor="let stat of stats" [class]="stat.color">
      <div class="stat-icon">{{ stat.icon }}</div>
      <div class="stat-content">
        <div class="stat-label">{{ stat.label }}</div>
        <div class="stat-value">{{ stat.value }}</div>
        <div class="stat-trend" [class.positive]="stat.trend.startsWith('+')">{{ stat.trend }}</div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-section">
    <div class="search-bar">
      <span class="icon">üîç</span>
      <input type="text" placeholder="Search by tenant or invoice #..." [(ngModel)]="searchTenant" (ngModelChange)="onFilterChange()">
    </div>
    <div class="filters">
      <select class="filter-select" [(ngModel)]="selectedPeriod" (ngModelChange)="onFilterChange()">
        <option value="all">All Time</option>
        <option value="7">Last 7 days</option>
        <option value="30">Last 30 days</option>
        <option value="90">Last 90 days</option>
        <option value="Q1">Q1 (Jan-Mar)</option>
        <option value="Q2">Q2 (Apr-Jun)</option>
        <option value="Q3">Q3 (Jul-Sep)</option>
        <option value="Q4">Q4 (Oct-Dec)</option>
        <option value="365">This Year</option>
      </select>
      <select class="filter-select" [(ngModel)]="selectedStatus" (ngModelChange)="onFilterChange()">
        <option value="all">All Status</option>
        <option value="draft">Draft</option>
        <option value="sent">Sent</option>
        <option value="paid">Paid</option>
        <option value="cancelled">Cancelled</option>
        <option value="refunded">Refunded</option>
      </select>
    </div>
  </div>

  <!-- Invoices Table -->
  <div class="table-container">
    <table class="data-table" role="table">
      <thead>
        <tr>
          <th (click)="sortBy('invoiceNumber')" class="sortable">
            Invoice #
            <span class="sort-icon" *ngIf="sortField === 'invoiceNumber'">{{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}</span>
          </th>
          <th (click)="sortBy('tenantName')" class="sortable">
            Tenant
            <span class="sort-icon" *ngIf="sortField === 'tenantName'">{{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}</span>
          </th>
          <th (click)="sortBy('amount')" class="sortable">
            Amount
            <span class="sort-icon" *ngIf="sortField === 'amount'">{{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}</span>
          </th>
          <th (click)="sortBy('dueDate')" class="sortable">
            Due Date
            <span class="sort-icon" *ngIf="sortField === 'dueDate'">{{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}</span>
          </th>
          <th (click)="sortBy('paidDate')" class="sortable">
            Paid Date
            <span class="sort-icon" *ngIf="sortField === 'paidDate'">{{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}</span>
          </th>
          <th (click)="sortBy('status')" class="sortable">
            Status
            <span class="sort-icon" *ngIf="sortField === 'status'">{{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}</span>
          </th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let invoice of invoices">
          <td><strong>{{ invoice.invoiceNumber }}</strong></td>
          <td>{{ invoice.tenantName }}</td>
          <td>${{ invoice.amount }}</td>
          <td>{{ invoice.dueDate | date:'MMM d, yyyy' }}</td>
          <td>{{ invoice.paidDate ? (invoice.paidDate | date:'MMM d, yyyy') : '-' }}</td>
          <td><span class="badge" [class]="invoice.status">{{ invoice.status | uppercase }}</span></td>
          <td>
            <div class="action-buttons">
              <button class="btn-action" (click)="viewInvoice(invoice)">View</button>
              <button class="btn-action" (click)="editInvoice(invoice)" *ngIf="invoice.status === 'DRAFT'">Edit</button>
              <button class="btn-action" (click)="downloadInvoice(invoice)">Download</button>
              <button class="btn-action" *ngIf="invoice.status === 'DRAFT' || invoice.status === 'SENT'" (click)="sendInvoice(invoice)">{{ invoice.status === 'SENT' ? 'Resend' : 'Send' }}</button>
              <button class="btn-action" *ngIf="invoice.status === 'FAILED'" (click)="retryPayment(invoice)">Retry</button>
              <button class="btn-action" *ngIf="invoice.status === 'SENT'" (click)="markAsPaid(invoice)">Mark Paid</button>
              <button class="btn-action danger" *ngIf="invoice.status === 'PAID'" (click)="refundPayment(invoice)">Refund</button>
              <button class="btn-action danger" *ngIf="invoice.status === 'DRAFT'" (click)="voidInvoice(invoice)">Void</button>
              <button class="btn-action danger" *ngIf="invoice.status === 'SENT'" (click)="voidInvoice(invoice)">Cancel</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="pagination">
    <div class="pagination-info">
      Showing {{ currentPage * itemsPerPage + 1 }} to {{ Math.min((currentPage + 1) * itemsPerPage, totalElements) }} of {{ totalElements }} invoices
    </div>
    <div class="pagination-controls">
      <select [(ngModel)]="itemsPerPage" (change)="onItemsPerPageChange()">
        <option [value]="25">25 per page</option>
        <option [value]="50">50 per page</option>
        <option [value]="100">100 per page</option>
      </select>
      <button [disabled]="currentPage === 0" (click)="previousPage()">Previous</button>
      <span class="page-info">Page {{ currentPage + 1 }} of {{ totalPages }}</span>
      <button [disabled]="currentPage >= totalPages - 1" (click)="nextPage()">Next</button>
    </div>
  </div>
</div>

<!-- Invoice Details/Create Modal -->
<div class="modal-overlay" *ngIf="showInvoiceModal" (click)="closeInvoiceModal()">
  <div class="modal-content large" (click)="$event.stopPropagation()" role="dialog">
    <div class="modal-header">
      <h2>{{ selectedInvoice ? 'Invoice Details' : 'Create Manual Invoice' }}</h2>
      <button class="close-btn" (click)="closeInvoiceModal()" aria-label="Close">&times;</button>
    </div>
    
    <!-- Create Invoice Form -->
    <div class="modal-body" *ngIf="!selectedInvoice">
      <div class="form-group">
        <label>Organization *</label>
        <select class="form-control" [(ngModel)]="newInvoice.tenantId">
          <option value="">Select organization...</option>
          <option *ngFor="let tenant of tenants" [value]="tenant.id">{{ tenant.name }}</option>
        </select>
      </div>
      <div class="form-group">
        <label>Amount *</label>
        <input type="number" class="form-control" [(ngModel)]="newInvoice.amount" placeholder="0.00">
      </div>
      <div class="form-group">
        <label>Currency</label>
        <select class="form-control" [(ngModel)]="newInvoice.currency">
          <option value="USD">USD</option>
          <option value="EUR">EUR</option>
          <option value="GBP">GBP</option>
        </select>
      </div>
      <div class="form-group">
        <label>Due Date *</label>
        <input type="date" class="form-control" [(ngModel)]="newInvoice.dueDate">
      </div>
      <div class="form-group">
        <label>Description</label>
        <textarea class="form-control" rows="3" [(ngModel)]="newInvoice.description" placeholder="Invoice description..."></textarea>
      </div>
    </div>
    
    <!-- View Invoice Details -->
    <div class="modal-body" *ngIf="selectedInvoice">
      <div class="invoice-header">
        <div>
          <h3>{{ selectedInvoice.invoiceNumber }}</h3>
          <p>{{ selectedInvoice.tenantName }}</p>
        </div>
        <div class="invoice-amount">
          <div class="amount-label">Amount Due</div>
          <div class="amount-value">${{ selectedInvoice.amount }}</div>
        </div>
      </div>
      
      <div class="details-grid">
        <div class="detail-item">
          <label>Status</label>
          <span class="badge" [class]="selectedInvoice.status">{{ selectedInvoice.status | uppercase }}</span>
        </div>
        <div class="detail-item">
          <label>Due Date</label>
          <span>{{ selectedInvoice.dueDate | date:'MMM d, yyyy' }}</span>
        </div>
        <div class="detail-item">
          <label>Paid Date</label>
          <span>{{ selectedInvoice.paidDate ? (selectedInvoice.paidDate | date:'MMM d, yyyy') : 'Not paid' }}</span>
        </div>
        <div class="detail-item">
          <label>Invoice Number</label>
          <span>{{ selectedInvoice.invoiceNumber }}</span>
        </div>
      </div>

      <div class="invoice-actions">
        <button class="btn-secondary" (click)="downloadInvoice(selectedInvoice)">üì• Download PDF</button>
        <button class="btn-secondary" (click)="sendInvoice(selectedInvoice)">üìß Send Email</button>
        <button class="btn-secondary" *ngIf="selectedInvoice.status === 'FAILED'" (click)="retryPayment(selectedInvoice)">üîÑ Retry Payment</button>
        <button class="btn-danger" *ngIf="selectedInvoice.status === 'PAID'" (click)="refundPayment(selectedInvoice)">üí∏ Issue Refund</button>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" (click)="closeInvoiceModal()">{{ selectedInvoice ? 'Close' : 'Cancel' }}</button>
      <button class="btn-primary" *ngIf="!selectedInvoice" (click)="submitManualInvoice()">Create Invoice</button>
    </div>
  </div>
</div>

<!-- Custom Notification -->
<div class="notification-overlay" *ngIf="notification.show">
  <div class="notification-card" [class.success]="notification.type === 'success'" [class.error]="notification.type === 'error'">
    <div class="notification-icon">
      <span *ngIf="notification.type === 'success'">‚úì</span>
      <span *ngIf="notification.type === 'error'">‚úï</span>
    </div>
    <div class="notification-content">
      <h3>{{ notification.title }}</h3>
      <p>{{ notification.message }}</p>
    </div>
    <button class="notification-close" (click)="notification.show = false">‚úï</button>
  </div>
</div>

<!-- Custom Confirmation -->
<div class="notification-overlay" *ngIf="confirmation.show">
  <div class="confirmation-card">
    <div class="confirmation-icon">‚ö†</div>
    <div class="confirmation-content">
      <h3>{{ confirmation.title }}</h3>
      <p>{{ confirmation.message }}</p>
    </div>
    <div class="confirmation-actions">
      <button class="btn-secondary" (click)="cancelConfirmation()">Cancel</button>
      <button class="btn-primary" (click)="confirmAction()">Confirm</button>
    </div>
  </div>
</div>


<!-- Pending Refunds Modal -->
<div class="modal-overlay" *ngIf="showRefundsModal" (click)="closeRefundsModal()">
  <div class="modal-content large" (click)="$event.stopPropagation()" role="dialog">
    <div class="modal-header">
      <h2>Pending Refund Approvals</h2>
      <button class="close-btn" (click)="closeRefundsModal()" aria-label="Close">&times;</button>
    </div>
    
    <div class="modal-body">
      <div *ngIf="pendingRefunds.length === 0" class="empty-state">
        <p>No pending refunds</p>
      </div>

      <div *ngFor="let refund of pendingRefunds" class="refund-card">
        <div class="refund-header">
          <div>
            <h3>{{ refund.creditNoteNumber }}</h3>
            <p>Invoice: {{ refund.invoiceId }}</p>
          </div>
          <div class="refund-amount-display">
            <div class="amount-label">Refund Amount</div>
            <div class="amount-value">${{ refund.amount }}</div>
          </div>
        </div>

        <div class="refund-details">
          <div class="detail-row">
            <span class="detail-label">Reason:</span>
            <span>{{ refund.reason }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Requested:</span>
            <span>{{ refund.createdAt | date:'MMM d, yyyy h:mm a' }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Method:</span>
            <span>{{ refund.refundMethod }}</span>
          </div>
        </div>

        <div class="refund-actions">
          <button class="btn-danger" (click)="rejectRefund(refund)">Reject</button>
          <button class="btn-primary" (click)="approveRefund(refund)">Approve Refund</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Reject Refund Modal -->
<div class="modal-overlay" *ngIf="showRejectModal" (click)="closeRejectModal()">
  <div class="modal-content" (click)="$event.stopPropagation()" role="dialog">
    <div class="modal-header">
      <h2>Reject Refund</h2>
      <button class="close-btn" (click)="closeRejectModal()" aria-label="Close">&times;</button>
    </div>
    
    <div class="modal-body">
      <p>Please provide a reason for rejecting this refund:</p>
      <div class="form-group">
        <label>Rejection Reason *</label>
        <textarea class="form-control" rows="4" [(ngModel)]="rejectionReason" placeholder="Enter reason..."></textarea>
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="btn-secondary" (click)="closeRejectModal()">Cancel</button>
      <button class="btn-danger" (click)="confirmRejectRefund()">Reject Refund</button>
    </div>
  </div>
</div>
